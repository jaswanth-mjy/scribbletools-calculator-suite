<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScribbleTools - Click Statistics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #F8F4E8; }
        .handwritten { font-family: 'Caveat', cursive; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="handwritten text-6xl font-bold text-red-600 mb-4">ScribbleTools</h1>
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Click Statistics Dashboard</h2>
                <p class="text-lg text-gray-600">Track tool usage and popular features</p>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold">üìä</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Total Clicks</dt>
                                <dd class="text-3xl font-bold text-gray-900" id="total-clicks">Loading...</dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold">üõ†Ô∏è</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Active Tools</dt>
                                <dd class="text-3xl font-bold text-gray-900" id="active-tools">Loading...</dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold">üì±</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Categories</dt>
                                <dd class="text-3xl font-bold text-gray-900" id="total-categories">Loading...</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Tools and Categories -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Top Tools -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Top Tools by Clicks</h3>
                        <div class="flow-root">
                            <ul id="top-tools-list" class="-my-5 divide-y divide-gray-200">
                                <li class="py-4 text-center text-gray-500">Loading...</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Category Statistics -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Categories by Usage</h3>
                        <div class="flow-root">
                            <ul id="category-stats-list" class="-my-5 divide-y divide-gray-200">
                                <li class="py-4 text-center text-gray-500">Loading...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Refresh Button -->
            <div class="text-center mt-8">
                <button id="refresh-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                    Refresh Data
                </button>
                <p class="text-sm text-gray-500 mt-2">Last updated: <span id="last-updated">Never</span></p>
            </div>
        </div>
    </div>

    <script>
        let isLoading = false;

        async function loadDashboardData() {
            if (isLoading) return;
            isLoading = true;
            
            try {
                // Load top tools
                const toolsResponse = await fetch('/api/track-click.php?action=stats&limit=20');
                const toolsData = await toolsResponse.json();

                // Load category statistics
                const categoriesResponse = await fetch('/api/track-click.php?action=categories');
                const categoriesData = await categoriesResponse.json();

                if (toolsData.success && categoriesData.success) {
                    updateDashboard(toolsData.data, categoriesData.data);
                } else {
                    console.error('Failed to load dashboard data');
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showErrorMessage();
            } finally {
                isLoading = false;
            }
        }

        function updateDashboard(toolsData, categoriesData) {
            // Update summary statistics
            const totalClicks = toolsData.reduce((sum, tool) => sum + parseInt(tool.click_count), 0);
            document.getElementById('total-clicks').textContent = totalClicks.toLocaleString();
            document.getElementById('active-tools').textContent = toolsData.length;
            document.getElementById('total-categories').textContent = categoriesData.length;

            // Update top tools list
            const toolsList = document.getElementById('top-tools-list');
            toolsList.innerHTML = toolsData.map((tool, index) => `
                <li class="py-4">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                ${index + 1}
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${tool.tool_name}</p>
                            <p class="text-sm text-gray-500">${tool.tool_category}</p>
                        </div>
                        <div class="inline-flex items-center text-base font-semibold text-gray-900">
                            ${parseInt(tool.click_count).toLocaleString()} clicks
                        </div>
                    </div>
                </li>
            `).join('');

            // Update categories list
            const categoriesList = document.getElementById('category-stats-list');
            categoriesList.innerHTML = categoriesData.map(category => {
                const percentage = ((category.total_clicks / totalClicks) * 100).toFixed(1);
                return `
                    <li class="py-4">
                        <div class="flex items-center space-x-4">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900">${category.tool_category}</p>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="bg-gradient-to-r from-green-500 to-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-gray-900">${parseInt(category.total_clicks).toLocaleString()}</p>
                                <p class="text-xs text-gray-500">${category.tool_count} tools (${percentage}%)</p>
                            </div>
                        </div>
                    </li>
                `;
            }).join('');

            // Update timestamp
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }

        function showErrorMessage() {
            document.getElementById('top-tools-list').innerHTML = '<li class="py-4 text-center text-red-500">Failed to load data</li>';
            document.getElementById('category-stats-list').innerHTML = '<li class="py-4 text-center text-red-500">Failed to load data</li>';
        }

        // Event listeners
        document.getElementById('refresh-btn').addEventListener('click', loadDashboardData);

        // Auto-refresh every 30 seconds
        setInterval(loadDashboardData, 30000);

        // Initial load
        loadDashboardData();
    </script>
</body>
</html>