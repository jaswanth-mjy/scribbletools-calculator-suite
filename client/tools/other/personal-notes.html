<!-- Personal Notes Tool - Compatible with main app embedding -->
<div class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">üìù Personal Notes</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="mb-4">
                <label for="noteTitle" class="block text-sm font-medium text-gray-700 mb-2">Note Title</label>
                <input type="text" id="noteTitle" placeholder="Enter note title..." 
                       class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div class="mb-4">
                <label for="noteContent" class="block text-sm font-medium text-gray-700 mb-2">Your Notes</label>
                <textarea id="noteContent" rows="10" placeholder="Write your notes here... (Saved automatically in your browser)" 
                          class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            
            <div class="flex gap-4 mb-6">
                <button onclick="saveNote()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors">
                    üíæ Save Note
                </button>
                <button onclick="newNote()" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition-colors">
                    ‚ú® New Note
                </button>
                <button onclick="downloadNotes()" class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 transition-colors">
                    üì• Download All Notes
                </button>
            </div>
            
            <div class="border-t pt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">üìö Your Saved Notes</h3>
                <div id="notesList" class="space-y-2">
                    <!-- Notes will be displayed here -->
                </div>
            </div>
        </div>
    </div>
</div>

    <script>
        // Personal notes system - stores locally in browser
        let currentNoteId = null;

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function loadNotes() {
            console.log('üìù Loading personal notes...');
            try {
                const notes = JSON.parse(localStorage.getItem('scribbletools_notes') || '[]');
                console.log('üìù Found', notes.length, 'notes in storage');
                const notesList = document.getElementById('notesList');
                
                if (!notesList) {
                    console.error('üìù Error: notesList element not found');
                    return;
                }
                
                if (notes.length === 0) {
                    notesList.innerHTML = '<p class="text-gray-500 italic">No notes saved yet. Create your first note!</p>';
                    return;
                }
                
                notesList.innerHTML = notes.map(note => `
                    <div class="bg-gray-50 p-4 rounded-md border border-gray-200">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">${escapeHtml(note.title || 'Untitled Note')}</h4>
                                <p class="text-sm text-gray-600 mt-1">${escapeHtml(note.content.substring(0, 100))}${note.content.length > 100 ? '...' : ''}</p>
                                <p class="text-xs text-gray-400 mt-2">${new Date(note.timestamp).toLocaleString()}</p>
                            </div>
                            <div class="flex gap-2 ml-4">
                                <button onclick="editNote('${note.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                <button onclick="deleteNote('${note.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                console.log('üìù Notes loaded successfully');
            } catch (error) {
                console.error('üìù Error loading notes:', error);
                const notesList = document.getElementById('notesList');
                if (notesList) {
                    notesList.innerHTML = '<p class="text-red-500">Error loading notes. Please refresh the page.</p>';
                }
            }
        }

        function saveNote() {
            console.log('üìù saveNote called, currentNoteId:', currentNoteId);
            const titleElement = document.getElementById('noteTitle');
            const contentElement = document.getElementById('noteContent');
            
            if (!titleElement || !contentElement) {
                console.error('üìù Error: Required elements not found', { titleElement, contentElement });
                alert('Error: Form elements not found. Please refresh the page.');
                return;
            }
            
            const title = titleElement.value.trim();
            const content = contentElement.value.trim();
            
            if (!title && !content) {
                alert('Please enter a title or content for your note.');
                return;
            }
            
            try {
                const notes = JSON.parse(localStorage.getItem('scribbletools_notes') || '[]');
                console.log('üìù Current notes in storage:', notes.length);
                
                if (currentNoteId) {
                    // Update existing note
                    const noteIndex = notes.findIndex(note => note.id === currentNoteId);
                    if (noteIndex !== -1) {
                        notes[noteIndex] = {
                            ...notes[noteIndex],
                            title,
                            content,
                            timestamp: Date.now()
                        };
                        console.log('üìù Updated existing note:', notes[noteIndex]);
                    }
                } else {
                    // Create new note
                    const newNote = {
                        id: generateId(),
                        title,
                        content,
                        timestamp: Date.now()
                    };
                    notes.unshift(newNote);
                    console.log('üìù Created new note:', newNote);
                    console.log('üìù Total notes after creation:', notes.length);
                    
                    // Clear the form after creating a new note
                    currentNoteId = null;
                    titleElement.value = '';
                    contentElement.value = '';
                    titleElement.focus();
                }
                
                localStorage.setItem('scribbletools_notes', JSON.stringify(notes));
                console.log('üìù Saved to localStorage, total notes:', notes.length);
                loadNotes();
                
                // Show success message
                const saveBtn = document.querySelector('button[onclick="saveNote()"]');
                if (saveBtn) {
                    const originalText = saveBtn.textContent;
                    if (currentNoteId) {
                        saveBtn.textContent = '‚úÖ Updated!';
                    } else {
                        saveBtn.textContent = '‚úÖ Saved!';
                    }
                    saveBtn.className = 'bg-green-600 text-white px-6 py-2 rounded-md';
                    setTimeout(() => {
                        saveBtn.textContent = 'üíæ Save New Note';
                        saveBtn.className = 'bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors';
                    }, 2000);
                }
            } catch (error) {
                console.error('üìù Error saving note:', error);
                alert('Error saving note. Please try again.');
            }
        }

        function newNote() {
            currentNoteId = null;
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteTitle').focus();
            
            // Update button text to indicate new note mode
            const saveBtn = document.querySelector('button[onclick="saveNote()"]');
            if (saveBtn) {
                saveBtn.textContent = 'üíæ Save New Note';
                saveBtn.className = 'bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors';
            }
            
            console.log('üìù Started new note');
        }

        function editNote(id) {
            const notes = JSON.parse(localStorage.getItem('scribbletools_notes') || '[]');
            const note = notes.find(n => n.id === id);
            
            if (note) {
                currentNoteId = id;
                document.getElementById('noteTitle').value = note.title || '';
                document.getElementById('noteContent').value = note.content || '';
                document.getElementById('noteTitle').scrollIntoView({ behavior: 'smooth' });
                
                // Update button text to indicate edit mode
                const saveBtn = document.querySelector('button[onclick="saveNote()"]');
                if (saveBtn) {
                    saveBtn.textContent = 'üíæ Update Note';
                    saveBtn.className = 'bg-orange-600 text-white px-6 py-2 rounded-md hover:bg-orange-700 transition-colors';
                }
                
                console.log('üìù Editing note:', note.title || 'Untitled');
            }
        }

        function deleteNote(id) {
            if (confirm('Are you sure you want to delete this note?')) {
                const notes = JSON.parse(localStorage.getItem('scribbletools_notes') || '[]');
                const filteredNotes = notes.filter(note => note.id !== id);
                localStorage.setItem('scribbletools_notes', JSON.stringify(filteredNotes));
                
                if (currentNoteId === id) {
                    newNote();
                }
                
                loadNotes();
            }
        }

        function downloadNotes() {
            const notes = JSON.parse(localStorage.getItem('scribbletools_notes') || '[]');
            
            if (notes.length === 0) {
                alert('No notes to download.');
                return;
            }
            
            const notesText = notes.map(note => 
                `Title: ${note.title || 'Untitled'}\n` +
                `Date: ${new Date(note.timestamp).toLocaleString()}\n` +
                `Content:\n${note.content}\n` +
                `${'='.repeat(50)}\n`
            ).join('\n');
            
            const blob = new Blob([notesText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ScribbleTools_Notes_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // IMMEDIATELY expose all functions globally - CRITICAL for onclick handlers
        window.saveNote = saveNote;
        window.newNote = newNote;
        window.editNote = editNote;
        window.deleteNote = deleteNote;
        window.downloadNotes = downloadNotes;
        window.loadNotes = loadNotes;
        window.generateId = generateId;
        window.escapeHtml = escapeHtml;
        
        console.log('üìù Personal Notes functions exposed globally:', {
            saveNote: typeof window.saveNote,
            newNote: typeof window.newNote,
            editNote: typeof window.editNote,
            deleteNote: typeof window.deleteNote,
            downloadNotes: typeof window.downloadNotes
        });

        // Auto-save functionality
        let autoSaveTimeout;
        
        // Wait for DOM to be ready before adding event listeners
        function initializeAutoSave() {
            const noteContentElement = document.getElementById('noteContent');
            if (noteContentElement) {
                noteContentElement.addEventListener('input', () => {
                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(() => {
                        // Only auto-save if we're editing an existing note
                        if (currentNoteId && document.getElementById('noteContent').value.trim()) {
                            console.log('üìù Auto-saving existing note...');
                            saveNote();
                        }
                    }, 3000); // Auto-save after 3 seconds of inactivity
                });
                console.log('üìù Auto-save initialized');
            } else {
                console.warn('üìù noteContent element not found for auto-save');
            }
        }

        // Enhanced initialization for both standalone and embedded usage
        function initializePersonalNotes() {
            console.log('üìù Initializing Personal Notes...');
            loadNotes();
            initializeAutoSave();
        }

        // Multiple initialization triggers
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePersonalNotes);
        } else {
            // DOM already loaded
            setTimeout(initializePersonalNotes, 100);
        }
        
        // Also load when the tool is initialized from main app
        window.addEventListener('load', initializePersonalNotes);
        
        // Make initialization function globally available
        window.initializePersonalNotes = initializePersonalNotes;
        
        // For debugging - expose debug object
        window.personalNotesDebug = {
            loadNotes,
            saveNote,
            newNote,
            editNote,
            deleteNote,
            downloadNotes,
            generateId,
            escapeHtml,
            currentNoteId: () => currentNoteId
        };
    </script>
