<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixelate Image - Add Retro Pixel Effect</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Caveat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #F8F4E8; color: #333; margin: 0; padding: 20px; min-height: 100vh; }
        main { display: block; }
        .reduce-size-container { max-width: 800px; margin: 3em auto; background: #fff; border-radius: 1.2em; box-shadow: 0 4px 24px #eae3d5; padding: 2em 1.5em 2.5em 1.5em; }
        .handwritten { font-family: 'Caveat', cursive; }
        h1 { font-family: 'Caveat', cursive; font-size: 3em; color: #D9534F; text-align: center; margin-bottom: 1em; font-weight: 700; }
        .description { text-align: center; color: #333; margin-bottom: 2em; font-size: 1.2em; }
        .upload-area { border: 3px dashed #D9534F; border-radius: 1em; padding: 3em 2em; text-align: center; margin: 2em 0; background: #FDFBF5; transition: all 0.3s; cursor: pointer; }
        .upload-area:hover { background: #F0F8FF; border-color: #4682B4; }
        .upload-area.dragover { background: #F0F8FF; border-color: #4682B4; }
        input[type="file"] { display: none; }
        .upload-btn { background: #D9534F; color: #fff; border: none; border-radius: 0.5em; padding: 1em 2em; font-weight: 600; cursor: pointer; transition: all 0.2s; display: block; margin: 0.8em auto 0 auto; }
        .upload-btn:hover { background: #c9302c; }
        .upload-icon { font-size: 3em; color: #D9534F; margin-bottom: 1em; }
        .controls-section { display: none; background: #FDFBF5; border: 1px solid #FFEAA7; border-radius: 0.7em; padding: 1.2em; margin: 2em 0; }
        .control-group { margin-bottom: 1.5em; }
        .control-group h3 { color: #4682B4; margin-bottom: 1em; font-size: 1.2em; }
        .pixelation-presets { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1em; margin-bottom: 1.5em; }
        .preset-button { background: white; border: 2px solid #EAE3D5; border-radius: 0.5em; padding: 1em; cursor: pointer; transition: all 0.3s ease; text-align: center; }
        .preset-button:hover { border-color: #D9534F; background: #FDFBF5; }
        .preset-button.selected { border-color: #D9534F; background: #FFF3CD; box-shadow: 0 0 10px rgba(217, 83, 79, 0.3); }
        .preset-button.selected .preset-icon { transform: scale(1.2); transition: transform 0.2s; }
        .preset-icon { font-size: 1.5em; margin-bottom: 0.5em; }
        .slider-control { margin: 1.2em 0; }
        .slider-control label { display: block; font-weight: 600; margin-bottom: 0.5em; color: #333; }
        .slider-wrapper { display: flex; align-items: center; gap: 1em; }
        .slider { flex: 1; height: 6px; border-radius: 3px; background: #EAE3D5; outline: none; -webkit-appearance: none; appearance: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #D9534F; cursor: pointer; }
        .slider::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #D9534F; cursor: pointer; border: none; }
        .slider-value { min-width: 50px; text-align: center; font-weight: bold; color: #D9534F; }
        .image-preview { display: none; text-align: center; margin: 2em 0; }
        .preview-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2em; margin: 2em 0; }
        .preview-box { text-align: center; }
        .preview-box h3 { color: #4682B4; margin-bottom: 1em; }
        .preview-box img, .preview-box canvas { max-width: 100%; max-height: 300px; border-radius: 0.5em; border: 1px solid #eee; margin: 1em 0; }
        .process-btn { background: #228B22; color: #fff; border: none; border-radius: 0.5em; padding: 1em 2em; font-weight: 600; cursor: pointer; transition: all 0.2s; width: 100%; font-size: 1.1em; }
        .process-btn:hover { background: #1e7e1e; }
        .download-btn { background: linear-gradient(135deg, #5CB85C 0%, #228B22 100%); color: #fff; border: none; border-radius: 0.5em; padding: 0.9em 2em; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-block; margin: 0.5em; font-size: 1.08em; box-shadow: 0 2px 12px #eae3d5; text-decoration: none; }
        .download-btn:hover { background: linear-gradient(135deg, #4CAF50 0%, #1e7e1e 100%); }
        .btn-secondary { background: #D9534F; color: #fff; border: none; border-radius: 0.5em; padding: 1em 2em; font-weight: 600; cursor: pointer; transition: all 0.2s; margin: 0.5em; }
        .btn-secondary:hover { background: #c9302c; }
        .download-section { display: none; text-align: center; margin: 2em 0; }
        .conversion-success-card { display: inline-block; margin-top: 1em; background: #E8F5E8; border: 2px solid #5CB85C; border-radius: 0.7em; padding: 1.2em 1em 1.5em 1em; margin-bottom: 1em; box-shadow: 0 2px 12px #eae3d5; }
        .success-icon { font-size: 2.2em; color: #5CB85C; margin-bottom: 0.3em; }
        .success-message { font-size: 1.15em; color: #228B22; font-family: 'Caveat', cursive; margin-bottom: 0.7em; text-align: center; }
        .related-links { margin-top: 2em; font-size: 1em; }
        .related-links a { color: #D9534F; text-decoration: underline; margin-right: 1.2em; }
        .related-links a:hover { color: #357abd; }
        .step-list { margin: 1.2em 0 1.2em 1.2em; padding: 0; }
        .step-list li { margin-bottom: 0.7em; }
        .warning-box { background: #FFF3CD; border: 1px solid #FFD700; border-radius: 0.7em; padding: 1em; margin-bottom: 1.2em; color: #B8860B; font-weight: bold; font-size: 1.1em; }
        .privacy-box { background: #FFF3CD; border: 1px solid #FFEAA7; border-radius: 0.5em; padding: 1em; margin: 1em 0; font-size: 0.95em; color: #856404; }
        @media (max-width: 768px) { .reduce-size-container { margin: 1em; padding: 1em 0.2em; } .preview-container { grid-template-columns: 1fr; } .pixelation-presets { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <main>
        <div class="reduce-size-container">
            <header>
                <h1 class="handwritten">🎮 Pixelate Image</h1>
                <p class="description">
                    Add retro pixel effect to your images. Create 8-bit style artwork, censor sensitive areas, 
                    or achieve vintage gaming aesthetics with customizable pixelation levels.
                </p>
            </header>

            <nav class="related-links">
                <strong>Related:</strong>
                <a href="/client/tools/image/picture-to-pixel-art.html">Picture to Pixel Art</a>
                <a href="/client/tools/image/grayscale-image.html">Grayscale Image</a>
                <a href="/client/tools/image/image-compressor.html">Image Compressor</a>
                <a href="/client/tools/image/black-white-image.html">Black & White</a>
            </nav>

            <section aria-labelledby="instructions-title" style="background: #F8FBFF; border-radius: 0.7em; padding: 1.5em; margin: 2em 0; border: 1px solid #4682B4;">
                <h2 id="instructions-title" style="color:#4682B4; margin-bottom: 1em; font-size: 1.5em;">How to Use</h2>
                <ol class="step-list" style="margin-left: 1.5em; line-height: 1.6;">
                    <li><strong style="color: #4682B4">Upload Your Image:</strong>
                        <ul style="margin: 0.5em 0 0.5em 1.5em; color: #666;">
                            <li>Drag & drop your image into the upload area</li>
                            <li>Or click "Choose File" to browse</li>
                        </ul>
                    </li>
                    <li><strong style="color: #4682B4">Choose Pixelation:</strong>
                        <ul style="margin: 0.5em 0 0.5em 1.5em; color: #666;">
                            <li>Pick a preset (Subtle, Light, Medium, Strong, Extreme)</li>
                            <li>Or set a custom pixel size with the slider</li>
                            <li>Optional: adjust opacity to blend with the original</li>
                        </ul>
                    </li>
                    <li><strong style="color: #4682B4">Apply & Download:</strong>
                        <ul style="margin: 0.5em 0 0.5em 1.5em; color: #666;">
                            <li>Click "Apply Pixelation" to preview</li>
                            <li>Download the PNG result</li>
                        </ul>
                    </li>
                </ol>
            </section>

            <section class="example-section" style="background: #FDFBF5; border: 1px solid #FFEAA7; border-radius: 0.7em; padding: 1.5em; margin: 2em 0;">
              <h3 style="color: #4682B4; margin-bottom: 1em;">Common Uses & Tips</h3>
              <div style="margin-bottom: 1.2em;">
                <h4 style="color: #FF6B6B; margin-bottom: 0.5em;">📦 Common Uses</h4>
                <ul style="color: #666; margin-left: 1.2em;">
                  <li>Censor faces, license plates, or sensitive areas</li>
                  <li>Create retro 8-bit effects for posts and thumbnails</li>
                  <li>Generate pixel backgrounds, stickers, or textures</li>
                </ul>
              </div>
              <div>
                <h4 style="color: #FF6B6B; margin-bottom: 0.5em;">💡 Pro Tips</h4>
                <ul style="color: #666; margin-left: 1.2em;">
                  <li>Higher pixel size = stronger block effect</li>
                  <li>Use opacity to softly blend the effect</li>
                  <li>Export and layer in your editor for more control</li>
                </ul>
              </div>
            </section>

            <section>
                <h2 style="color:#D9534F;">Privacy Notice</h2>
                <div class="privacy-box">
                    <strong>🔒 Your files are never uploaded or stored. All processing happens in your browser.</strong>
                </div>
            </section>

            <div class="upload-area" id="uploadArea" tabindex="0" aria-label="Upload image area. Drag and drop or click to select an image.">
                <div class="upload-icon">🖼️</div>
                <h3>Drag & Drop your image here</h3>
                <p>or click to browse files</p>
                <input type="file" id="imageInput" accept="image/*" aria-label="Choose image file">
                <button class="upload-btn" id="choose-file-btn" aria-label="Choose File">Choose File</button>
            </div>

            <div class="controls-section" id="controlsSection">
                <div class="control-group">
                    <h3>🎯 Pixelation Presets</h3>
                    <div class="pixelation-presets">
                        <div class="preset-button" data-size="2" onclick="selectPreset(2)">
                            <div class="preset-icon">🔳</div>
                            <div><strong>Subtle</strong></div>
                            <div>2px blocks</div>
                        </div>
                        <div class="preset-button" data-size="4" onclick="selectPreset(4)">
                            <div class="preset-icon">◾</div>
                            <div><strong>Light</strong></div>
                            <div>4px blocks</div>
                        </div>
                        <div class="preset-button selected" data-size="8" onclick="selectPreset(8)">
                            <div class="preset-icon">▪️</div>
                            <div><strong>Medium</strong></div>
                            <div>8px blocks</div>
                        </div>
                        <div class="preset-button" data-size="16" onclick="selectPreset(16)">
                            <div class="preset-icon">⬛</div>
                            <div><strong>Strong</strong></div>
                            <div>16px blocks</div>
                        </div>
                        <div class="preset-button" data-size="32" onclick="selectPreset(32)">
                            <div class="preset-icon">⬛</div>
                            <div><strong>Extreme</strong></div>
                            <div>32px blocks</div>
                        </div>
                    </div>

                    <div class="slider-control">
                        <label for="pixelSize">🎛️ Custom Pixel Size</label>
                        <div class="slider-wrapper">
                            <input type="range" id="pixelSize" class="slider" min="1" max="300" value="8">
                            <span class="slider-value" id="pixelValue">8</span>
                        </div>
                    </div>

                    <div class="slider-control">
                        <label for="opacity">👻 Opacity</label>
                        <div class="slider-wrapper">
                            <input type="range" id="opacity" class="slider" min="0" max="100" value="100">
                            <span class="slider-value" id="opacityValue">100%</span>
                        </div>
                    </div>

                    <button class="process-btn" onclick="applyPixelation()" id="applyBtn">
                        🎮 Apply Pixelation
                    </button>
                </div>
            </div>

            <div class="image-preview" id="imagePreview">
                <div class="preview-container">
                    <div class="preview-box">
                        <h3>📷 Original Image</h3>
                        <img id="originalImage" alt="Original image">
                    </div>
                    <div class="preview-box">
                        <h3>🎮 Pixelated Image</h3>
                        <canvas id="pixelatedCanvas"></canvas>
                    </div>
                </div>
            </div>

            <div class="download-section" id="downloadSection">
                <div class="conversion-success-card">
                    <div class="success-icon">✅</div>
                    <div class="success-message">Your pixelated image is ready!</div>
                    <a href="#" class="download-btn" onclick="downloadResult(); return false;">Download Pixelated Image</a>
                    <button type="button" class="btn-secondary" onclick="resetTool()">🔄 Pixelate Another Image</button>
                </div>
            </div>

            <section class="feature-list" style="background: #FDFBF5; border-radius: 0.7em; padding: 1.2em; margin: 2em 0; border: 1px solid #FFEAA7;">
                <h2 style="color: #4682B4; margin-bottom: 1em;">Key Features</h2>
                <ul style="list-style: none; padding-left: 0;">
                    <li>✓ Presets and custom pixel size</li>
                    <li>✓ Opacity blending with original</li>
                    <li>✓ Instant preview and PNG download</li>
                    <li>✓ Works entirely in your browser (privacy-first)</li>
                </ul>
            </section>

            <nav class="recent-tools" aria-label="Recently used tools" style="background: #F8F9FA; border-radius: 0.7em; padding: 1.2em; margin: 1.5em 0;">
                <strong>Recent Tools:</strong>
                <div class="recent-tools-list" style="display: inline-block;">
                    <a href="/client/tools/image/picture-to-pixel-art.html">Picture to Pixel Art</a>
                    <a href="/client/tools/image/image-converter.html">Image Converter</a>
                    <a href="/client/tools/image/image-compressor.html">Image Compressor</a>
                    <span class="separator" style="margin: 0 0.5em; color: #999;">•</span>
                    <a href="#" id="clear-recent" style="color: #D9534F; font-size: 0.9em;">Clear History</a>
                </div>
            </nav>
        </div>
    </main>

    <script>
// Global variables
let currentFile = null;
let uploadedImage = null;
let canvas = null;
let ctx = null;
let isProcessing = false;
let isInitialized = false;

// Recent tools functionality (shared pattern)
const RECENT_TOOLS_KEY = 'recentImageTools';
const MAX_RECENT_TOOLS = 4;

// Helper functions
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function initRecentTools() {
    const currentToolData = { name: 'Pixelate Image', url: window.location.pathname };
    addToRecentTools(currentToolData);
    updateRecentToolsList();
    const clearRecentBtn = document.getElementById('clear-recent');
    if (clearRecentBtn) {
        clearRecentBtn.onclick = function(e) {
            e.preventDefault();
            localStorage.removeItem(RECENT_TOOLS_KEY);
            updateRecentToolsList();
        };
    }
}

function addToRecentTools(toolData) {
    let recentTools = JSON.parse(localStorage.getItem(RECENT_TOOLS_KEY) || '[]');
    recentTools = recentTools.filter(tool => tool.url !== toolData.url);
    recentTools.unshift(toolData);
    recentTools = recentTools.slice(0, MAX_RECENT_TOOLS);
    localStorage.setItem(RECENT_TOOLS_KEY, JSON.stringify(recentTools));
}

function updateRecentToolsList() {
    const recentToolsList = document.querySelector('.recent-tools-list');
    if (!recentToolsList) return;
    
    const recentTools = JSON.parse(localStorage.getItem(RECENT_TOOLS_KEY) || '[]');
    
    if (recentTools.length === 0) {
        recentToolsList.innerHTML = '<span style="color: #666;">No recent tools</span>';
        return;
    }
    
    const toolLinks = recentTools
        .filter(tool => tool.url !== window.location.pathname)
        .map(tool => `<a href="${tool.url}">${tool.name}</a>`)
        .join('<span class="separator" style="margin: 0 0.5em; color: #999;">•</span>');
    
    recentToolsList.innerHTML = toolLinks + 
        '<span class="separator" style="margin: 0 0.5em; color: #999;">•</span>' +
        '<a href="#" id="clear-recent" style="color: #D9534F; font-size: 0.9em;">Clear History</a>';
    
    // Re-attach clear event listener
    const clearRecentBtn = document.getElementById('clear-recent');
    if (clearRecentBtn) {
        clearRecentBtn.onclick = function(e) {
            e.preventDefault();
            localStorage.removeItem(RECENT_TOOLS_KEY);
            updateRecentToolsList();
        };
    }
}

function initializePixelateImageTool() {
    if (isInitialized) {
        console.log('Already initialized');
        return;
    }

    console.log('Setting up event listeners...');
    
    // Get elements
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    const chooseFileBtn = document.getElementById('choose-file-btn');
    
    if (!uploadArea || !imageInput || !chooseFileBtn) {
        console.error('Critical elements missing:', {
            uploadArea: !!uploadArea,
            imageInput: !!imageInput,
            chooseFileBtn: !!chooseFileBtn
        });
        setTimeout(initializePixelateImageTool, 100); // Retry
        return;
    }

    // Remove old listeners by cloning
    [uploadArea, imageInput, chooseFileBtn].forEach(el => {
        if (el && el.parentNode) {
            const newEl = el.cloneNode(true);
            el.parentNode.replaceChild(newEl, el);
        }
    });

    // Re-get elements after cloning
    const newUploadArea = document.getElementById('uploadArea');
    const newImageInput = document.getElementById('imageInput');
    const newChooseFileBtn = document.getElementById('choose-file-btn');

    // Click handlers
    if (newChooseFileBtn) {
        newChooseFileBtn.onclick = function(e) {
            e.preventDefault();
            if (!isProcessing) {
                console.log('🖱️ Choose file clicked');
                newImageInput.click();
            }
        };
    }

    if (newUploadArea) {
        newUploadArea.onclick = function(e) {
            if (e.target !== newChooseFileBtn && !isProcessing) {
                console.log('🖱️ Upload area clicked');
                newImageInput.click();
            }
        };
    }

    // File input change
    if (newImageInput) {
        newImageInput.onchange = function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                console.log('📁 File selected:', file.name);
                if (!isProcessing) {
                    startUploadProgress(file);
                }
                e.target.value = '';
            }
        };
    }

    // Drag and drop
    if (newUploadArea) {
        newUploadArea.ondragover = function(e) {
            e.preventDefault();
            if (!isProcessing) {
                newUploadArea.style.backgroundColor = '#F0F8FF';
                newUploadArea.style.borderColor = '#4682B4';
            }
        };

        newUploadArea.ondragleave = function() {
            newUploadArea.style.backgroundColor = '#FDFBF5';
            newUploadArea.style.borderColor = '#D9534F';
        };

        newUploadArea.ondrop = function(e) {
            e.preventDefault();
            newUploadArea.style.backgroundColor = '#FDFBF5';
            newUploadArea.style.borderColor = '#D9534F';
            if (!isProcessing && e.dataTransfer.files.length > 0) {
                startUploadProgress(e.dataTransfer.files[0]);
            }
        };
    }

    // Pixel size slider change
    const pixelSizeSlider = document.getElementById('pixelSize');
    if (pixelSizeSlider) {
        pixelSizeSlider.oninput = function() {
            const pixelValue = document.getElementById('pixelValue');
            if (pixelValue) {
                pixelValue.textContent = this.value;
            }
            updatePresetSelection(parseInt(this.value));
        };
        
        pixelSizeSlider.onchange = function() {
            const pixelValue = document.getElementById('pixelValue');
            if (pixelValue) {
                pixelValue.textContent = this.value;
            }
            updatePresetSelection(parseInt(this.value));
            console.log('🎛️ Slider changed to:', this.value);
        };
    }

    // Opacity change
    const opacitySlider = document.getElementById('opacity');
    if (opacitySlider) {
        opacitySlider.onchange = function() {
            const opacityValue = document.getElementById('opacityValue');
            if (opacityValue) {
                opacityValue.textContent = this.value + '%';
            }
        };
    }

    // Apply button
    const applyBtn = document.getElementById('applyBtn');
    if (applyBtn) {
        applyBtn.onclick = applyPixelation;
    }

    // Set default preset selection and ensure sync
    selectPreset(8);
    
    // Initial sync check
    setTimeout(() => {
        const pixelSizeSlider = document.getElementById('pixelSize');
        if (pixelSizeSlider) {
            updatePresetSelection(parseInt(pixelSizeSlider.value));
        }
    }, 100);
    
    isInitialized = true;
    console.log('✅ Pixelate Image Tool initialized successfully');
}

function startUploadProgress(file) {
    if (isProcessing) return;
    
    console.log('📤 Starting upload progress for:', file.name);
    
    // Reset related UI while "uploading"
    const controlsSection = document.getElementById('controlsSection');
    const imagePreview = document.getElementById('imagePreview');
    const downloadSection = document.getElementById('downloadSection');
    
    if (controlsSection) controlsSection.style.display = 'none';
    if (imagePreview) imagePreview.style.display = 'none';
    if (downloadSection) downloadSection.style.display = 'none';
    
    // Simulate upload progress
    setTimeout(() => {
        handleFile(file);
    }, 500);
}

function handleFile(file) {
    if (isProcessing) {
        console.log('⚠️ Already processing a file, skipping...');
        return;
    }
    
    isProcessing = true;
    currentFile = file;
    console.log('📤 Processing file:', file.name, 'Size:', file.size, 'Type:', file.type);
    
    if (!file.type.startsWith('image/')) {
        alert('❌ Please select a valid image file (JPEG, PNG, etc.).');
        isProcessing = false;
        return;
    }

    if (file.size > 10 * 1024 * 1024) {
        alert('❌ File size must be less than 10 MB.');
        isProcessing = false;
        return;
    }
    if (file.size < 15 * 1024) {
        alert('❌ File size must be at least 15 KB.');
        isProcessing = false;
        return;
    }

    const reader = new FileReader();
    
    reader.onload = function(e) {
        console.log('✅ File read successfully, loading image...');
        uploadedImage = new Image();
        
        uploadedImage.onload = function() {
            console.log('✅ Image loaded successfully:', uploadedImage.width, 'x', uploadedImage.height);
            const controlsSection = document.getElementById('controlsSection');
            // Set the original image preview
            const originalImageEl = document.getElementById('originalImage');
            const imagePreview = document.getElementById('imagePreview');
            if (originalImageEl) {
                originalImageEl.src = uploadedImage.src;
            }
            if (imagePreview) {
                imagePreview.style.display = 'none'; // will show after pixelation
            }
            if (controlsSection) {
                controlsSection.style.display = 'block';
            }
            isProcessing = false;
            console.log('✅ UI updated successfully');
        };
        
        uploadedImage.onerror = function(err) {
            console.error('❌ Error loading image:', err);
            alert('Error loading image. Please try a different file.');
            isProcessing = false;
        };
        
        uploadedImage.src = e.target.result;
    };
    
    reader.onerror = function(err) {
        console.error('❌ Error reading file:', err);
        alert('Error reading file. Please try again.');
        isProcessing = false;
    };
    
    reader.readAsDataURL(file);
}

function selectPreset(size) {
    console.log('🎯 Selecting preset:', size);
    
    // Remove previous selection
    document.querySelectorAll('.preset-button').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    // Select current preset
    const targetButton = document.querySelector(`[data-size="${size}"]`);
    if (targetButton) {
        targetButton.classList.add('selected');
        console.log('✅ Preset button selected:', size);
    } else {
        console.warn('⚠️ Preset button not found for size:', size);
    }
    
    // Update slider
    const pixelSizeSlider = document.getElementById('pixelSize');
    if (pixelSizeSlider) {
        pixelSizeSlider.value = size;
        console.log('🎛️ Slider updated to:', size);
    } else {
        console.warn('⚠️ Pixel size slider not found');
    }
    
    const pixelValue = document.getElementById('pixelValue');
    if (pixelValue) {
        pixelValue.textContent = size;
        console.log('📊 Pixel value display updated to:', size);
    } else {
        console.warn('⚠️ Pixel value display not found');
    }
    
    // Trigger change event on slider to ensure all listeners are notified
    if (pixelSizeSlider) {
        const event = new Event('change', { bubbles: true });
        pixelSizeSlider.dispatchEvent(event);
        console.log('🔄 Slider change event triggered for size:', size);
    }
}

function updatePresetSelection(size) {
    console.log('🔄 Updating preset selection for size:', size);
    
    // Remove previous selection
    document.querySelectorAll('.preset-button').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    // Find the closest preset match
    const presetSizes = [2, 4, 8, 16, 32];
    let closestSize = 8; // Default to medium
    let minDifference = Math.abs(size - 8);
    
    for (const presetSize of presetSizes) {
        const difference = Math.abs(size - presetSize);
        if (difference < minDifference) {
            minDifference = difference;
            closestSize = presetSize;
        }
    }
    
    // Select the closest preset
    const targetButton = document.querySelector(`[data-size="${closestSize}"]`);
    if (targetButton) {
        targetButton.classList.add('selected');
        console.log('🎯 Closest preset selected:', closestSize, 'for slider value:', size);
    }
    
    // If the size exactly matches a preset, highlight it more prominently
    if (presetSizes.includes(size)) {
        console.log('🎯 Exact preset match found:', size);
    }
}

function applyPixelation() {
    if (!uploadedImage) { 
        alert('Please upload an image first.'); 
        return; 
    }

    if (isProcessing) {
        console.log('⚠️ Already processing, please wait...');
        return;
    }

    isProcessing = true;
    
    const pixelSizeSlider = document.getElementById('pixelSize');
    const opacitySlider = document.getElementById('opacity');
    const pixelatedCanvas = document.getElementById('pixelatedCanvas');
    const imagePreview = document.getElementById('imagePreview');
    const downloadSection = document.getElementById('downloadSection');
    
    if (!pixelatedCanvas) { 
        alert('Canvas not available. Please reload the page.'); 
        isProcessing = false;
        return; 
    }
    
    const ctx = pixelatedCanvas.getContext('2d');
    if (!ctx) { 
        alert('Unable to initialize canvas context.'); 
        isProcessing = false;
        return; 
    }
    
    const pixelSize = parseInt(pixelSizeSlider.value);
    const opacity = parseFloat(opacitySlider.value) / 100;

    console.log('🎮 Applying pixelation with size:', pixelSize, 'opacity:', opacity);

    // Set canvas size to match original image
    pixelatedCanvas.width = uploadedImage.width;
    pixelatedCanvas.height = uploadedImage.height;

    // Clear canvas
    ctx.clearRect(0, 0, pixelatedCanvas.width, pixelatedCanvas.height);

    // Draw original image with reduced opacity if needed
    if (opacity < 1) {
        ctx.globalAlpha = 1 - opacity;
        ctx.drawImage(uploadedImage, 0, 0);
        ctx.globalAlpha = opacity;
    }

    // Create pixelated effect
    ctx.imageSmoothingEnabled = false;

    // Calculate dimensions for pixelated version
    const scaledWidth = Math.ceil(pixelatedCanvas.width / pixelSize);
    const scaledHeight = Math.ceil(pixelatedCanvas.height / pixelSize);

    // Create temporary canvas for pixelation
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    tempCanvas.width = scaledWidth;
    tempCanvas.height = scaledHeight;

    // Draw scaled down version
    tempCtx.drawImage(uploadedImage, 0, 0, scaledWidth, scaledHeight);

    // Draw scaled up version (pixelated)
    ctx.drawImage(tempCanvas, 0, 0, scaledWidth, scaledHeight, 0, 0, pixelatedCanvas.width, pixelatedCanvas.height);

    // Reset global alpha
    ctx.globalAlpha = 1;

    if (imagePreview) imagePreview.style.display = 'block';
    if (downloadSection) downloadSection.style.display = 'block';
    
    isProcessing = false;
    console.log('✅ Pixelation applied successfully');
}

function downloadResult() {
    const pixelatedCanvas = document.getElementById('pixelatedCanvas');
    if (!pixelatedCanvas) {
        alert('Canvas not available. Please apply pixelation first.');
        return;
    }
    
    const link = document.createElement('a');
    link.download = 'pixelated-image.png';
    link.href = pixelatedCanvas.toDataURL('image/png');
    link.click();
    console.log('✅ Download initiated');
}

function resetTool() {
    const controlsSection = document.getElementById('controlsSection');
    const imagePreview = document.getElementById('imagePreview');
    const downloadSection = document.getElementById('downloadSection');
    
    if (controlsSection) controlsSection.style.display = 'none';
    if (imagePreview) imagePreview.style.display = 'none';
    if (downloadSection) downloadSection.style.display = 'none';

    // Clear both original image preview and pixelated canvas
    const originalImageEl = document.getElementById('originalImage');
    if (originalImageEl) {
        originalImageEl.src = '';
    }
    const pixelatedCanvas = document.getElementById('pixelatedCanvas');
    if (pixelatedCanvas) {
        const ctx = pixelatedCanvas.getContext('2d');
        if (ctx) ctx.clearRect(0, 0, pixelatedCanvas.width, pixelatedCanvas.height);
    }
    // Reset controls
    const pixelSizeSlider = document.getElementById('pixelSize');
    if (pixelSizeSlider) {
        pixelSizeSlider.value = 8;
    }
    
    const pixelValue = document.getElementById('pixelValue');
    if (pixelValue) {
        pixelValue.textContent = '8';
    }
    
    const opacitySlider = document.getElementById('opacity');
    if (opacitySlider) {
        opacitySlider.value = 100;
    }
    
    const opacityValue = document.getElementById('opacityValue');
    if (opacityValue) {
        opacityValue.textContent = '100%';
    }
    
    selectPreset(8);
    
    const imageInput = document.getElementById('imageInput');
    if (imageInput) {
        imageInput.value = '';
    }
    
    currentFile = null;
    uploadedImage = null;
    
    console.log('🔄 Tool reset successfully');
}

// Attach main functions to window for AJAX loader compatibility
window.resetTool = resetTool;
window.applyPixelation = applyPixelation;
window.selectPreset = selectPreset;
window.updatePresetSelection = updatePresetSelection;
window.downloadResult = downloadResult;

// Initialize when DOM is ready
if (document.readyState !== 'loading') {
    setTimeout(() => {
        initializePixelateImageTool();
        initRecentTools();
    }, 50);
} else {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            initializePixelateImageTool();
            initRecentTools();
        }, 50);
    });
}
    </script>
</body>
</html>
