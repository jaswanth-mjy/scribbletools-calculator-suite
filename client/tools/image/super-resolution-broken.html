<!-- File: tools/image/super-resolution.html -->
<style>
    .sr-container { max-width: 900px; margin: 0 auto; padding: 20px; }
    .sr-upload-area { background: #FDFBF5; border: 3px dashed #EAE3D5; border-radius: 1rem; padding: 3rem 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; margin: 2rem 0; }
    .sr-upload-area:hover, .sr-upload-area.dragover { border-color: #D9534F; background: #FFF9F9; }
    .sr-upload-area.dragover { transform: scale(1.02); }
    .sr-upload-area h3 { color: #666; margin: 0.5rem 0; font-size: 1.3rem; }
    .sr-upload-area p { color: #999; margin: 0.5rem 0; font-size: 1rem; }
    .sr-file-input { display: none; }
    .sr-upload-icon { font-size: 4rem; color: #D9534F; margin-bottom: 1rem; }
    .sr-upload-text { font-size: 1.3rem; color: #666; margin-bottom: 0.5rem; }
    .sr-upload-subtext { color: #999; font-size: 1rem; }
    .sr-btn { background: #D9534F; color: white; border: none; border-radius: 0.7rem; padding: 0.8rem 2rem; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; margin: 0.5rem; }
    .sr-btn:hover { background: #c14242; transform: translateY(-2px); }
    .sr-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .sr-btn-secondary { background: #6c757d; }
    .sr-btn-secondary:hover { background: #5a6268; }
    .sr-processing { display: none; text-align: center; margin: 2rem 0; }
    .sr-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #D9534F; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .sr-preview { display: none; margin: 2rem 0; }
    .sr-comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0; }
    .sr-image-container { text-align: center; background: #fff; border-radius: 0.7rem; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .sr-image-container h3 { color: #D9534F; margin-bottom: 1rem; font-size: 1.2rem; }
    .sr-image { max-width: 100%; max-height: 400px; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .sr-stats { background: #F8F9FA; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; }
    .sr-stat { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
    .sr-stat:last-child { margin-bottom: 0; }
    .sr-controls { background: #fff; border-radius: 0.7rem; padding: 1.5rem; margin: 2rem 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .sr-control-group { margin-bottom: 1.5rem; }
    .sr-control-group:last-child { margin-bottom: 0; }
    .sr-label { display: block; font-weight: 600; color: #333; margin-bottom: 0.5rem; }
    .sr-select, .sr-input { width: 100%; padding: 0.7rem; border: 2px solid #E5E5E5; border-radius: 0.5rem; font-size: 1rem; }
    .sr-select:focus, .sr-input:focus { outline: none; border-color: #D9534F; }
    .sr-info { background: #E7F3FF; border: 1px solid #B8DAFF; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0; color: #0C5460; }
    .sr-warning { background: #FFF3CD; border: 1px solid #FFEAA7; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0; color: #856404; }
    .sr-progress { background: #f0f0f0; border-radius: 0.5rem; height: 1.5rem; margin: 1rem 0; overflow: hidden; }
    .sr-progress-bar { background: linear-gradient(90deg, #D9534F, #E74C3C); height: 100%; transition: width 0.3s; width: 0%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9rem; }
    @media (max-width: 768px) {
        .sr-comparison { grid-template-columns: 1fr; gap: 1rem; }
        .sr-container { padding: 10px; }
    }
</style>
<div class="sr-container">
    <h2 class="handwritten text-5xl text-[#D9534F] mb-4">Super Resolution</h2>
    <div class="mb-6 p-6 bg-amber-50/70 rounded-lg border border-amber-200">
        <p class="text-lg text-gray-800 font-bold mb-2">Enhance and upscale your images using advanced AI-powered super-resolution algorithms. Increase resolution while preserving details and sharpness for photos, artwork, and graphics.</p>
        <ul class="list-disc list-inside text-gray-700 text-base">
            <li>AI-powered image upscaling (2x, 4x resolution)</li>
            <li>Edge enhancement and detail preservation</li>
            <li>Noise reduction and artifact removal</li>
            <li>Support for photos, artwork, and graphics</li>
            <li>Applications: photo enhancement, print preparation, digital restoration</li>
        </ul>
    </div>
    
    <div class="sr-upload-area" id="sr-upload-area" tabindex="0" aria-label="Upload image area. Drag and drop or click to select an image.">
        <div class="sr-upload-icon" aria-hidden="true">üñºÔ∏è</div>
        <h3>Drag & Drop your image here</h3>
        <p>or click to browse files</p>
        <p class="sr-upload-subtext">Supports JPG, PNG, WebP ‚Ä¢ Max file size: 10MB</p>
        <input type="file" id="sr-file-input" class="sr-file-input" accept="image/*" aria-label="Choose image file">
        <button class="sr-btn" id="sr-choose-file-btn" style="display:block; margin: 1em auto;" aria-label="Choose File">Choose File</button>
    </div>
    
    <div class="sr-preview-upload" id="sr-preview-upload" style="display: none;">
        <h3 style="color: #D9534F; text-align: center; margin-bottom: 1rem;">üì∑ Uploaded Image Preview</h3>
        <div style="text-align: center;">
            <img id="sr-uploaded-preview" class="sr-image" alt="Uploaded image preview" style="max-height: 300px;">
        </div>
        <div style="text-align: center; margin-top: 1em;">
            <button class="sr-btn sr-btn-secondary" id="sr-change-image-btn" type="button">üîÑ Upload Different Image</button>
        </div>
    </div>
    
    <div class="sr-controls" id="sr-controls" style="display: none;">
        <h3 style="color: #D9534F; margin-bottom: 1rem;">Enhancement Settings</h3>
        
        <div class="sr-control-group">
            <label class="sr-label" for="sr-scale-factor">Upscale Factor:</label>
            <select id="sr-scale-factor" class="sr-select">
                <option value="2">2x (Double Resolution)</option>
                <option value="4">4x (Quadruple Resolution)</option>
                <option value="8">8x (8x Resolution - Experimental)</option>
            </select>
        </div>
        
        <div class="sr-control-group">
            <label class="sr-label" for="sr-algorithm">Enhancement Algorithm:</label>
            <select id="sr-algorithm" class="sr-select">
                <option value="lanczos">Lanczos (High Quality)</option>
                <option value="bicubic">Bicubic (Smooth)</option>
                <option value="bilinear">Bilinear (Fast)</option>
                <option value="edge-preserve">Edge Preserving (Photos)</option>
                <option value="ai-enhance">AI Enhancement (Experimental)</option>
            </select>
        </div>
        
        <div class="sr-control-group">
            <label class="sr-label" for="sr-sharpening">Sharpening Strength:</label>
            <input type="range" id="sr-sharpening" min="0" max="100" value="30" class="sr-input">
            <span id="sr-sharpening-value">30%</span>
        </div>
        
        <div class="sr-control-group">
            <label class="sr-label" for="sr-noise-reduction">Noise Reduction:</label>
            <input type="range" id="sr-noise-reduction" min="0" max="100" value="20" class="sr-input">
            <span id="sr-noise-value">20%</span>
        </div>
        
        <button id="sr-enhance-btn" class="sr-btn">Enhance Image</button>
        <button id="sr-reset-btn" class="sr-btn sr-btn-secondary">Reset</button>
    </div>
    
    <div class="sr-info">
        <strong>üí° Tip:</strong> For best results, use high-quality source images. AI enhancement works particularly well on photos with clear subjects and good lighting.
    </div>
    
    <div class="sr-processing" id="sr-processing">
        <div class="sr-spinner"></div>
        <h3>Enhancing your image...</h3>
        <p>This may take a few moments depending on image size and enhancement settings.</p>
        <div class="sr-progress">
            <div class="sr-progress-bar" id="sr-progress-bar">0%</div>
        </div>
    </div>
    
    <div class="sr-preview" id="sr-preview">
        <h3 style="color: #D9534F; text-align: center; margin-bottom: 2rem;">Before & After Comparison</h3>
        
        <div class="sr-comparison">
            <div class="sr-image-container">
                <h3>Original</h3>
                <img id="sr-original-img" class="sr-image" alt="Original image">
                <div class="sr-stats">
                    <div class="sr-stat">
                        <span>Resolution:</span>
                        <span id="sr-original-resolution">-</span>
                    </div>
                    <div class="sr-stat">
                        <span>File Size:</span>
                        <span id="sr-original-size">-</span>
                    </div>
                </div>
            </div>
            
            <div class="sr-image-container">
                <h3>Enhanced</h3>
                <img id="sr-enhanced-img" class="sr-image" alt="Enhanced image">
                <div class="sr-stats">
                    <div class="sr-stat">
                        <span>Resolution:</span>
                        <span id="sr-enhanced-resolution">-</span>
                    </div>
                    <div class="sr-stat">
                        <span>File Size:</span>
                        <span id="sr-enhanced-size">-</span>
                    </div>
                    <div class="sr-stat">
                        <span>Enhancement:</span>
                        <span id="sr-enhancement-info">-</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 2rem;">
            <button id="sr-download-btn" class="sr-btn">Download Enhanced Image</button>
            <button id="sr-new-image-btn" class="sr-btn sr-btn-secondary">Process Another Image</button>
        </div>
    </div>
    
    <div class="sr-warning">
        <strong>‚ö†Ô∏è Performance Note:</strong> Higher upscale factors and AI enhancement may take longer to process and use more system resources. For very large images, consider using 2x scaling first.
    </div>
</div>

<script>
function initializeSuperResolution() {
    let originalImage = null;
    let originalFile = null;
    let enhancedCanvas = null;
    
    // Get DOM elements
    const uploadArea = document.getElementById('sr-upload-area');
    const fileInput = document.getElementById('sr-file-input');
    const chooseFileBtn = document.getElementById('sr-choose-file-btn');
    const previewUpload = document.getElementById('sr-preview-upload');
    const uploadedPreview = document.getElementById('sr-uploaded-preview');
    const changeImageBtn = document.getElementById('sr-change-image-btn');
    const controls = document.getElementById('sr-controls');
    const processing = document.getElementById('sr-processing');
    const preview = document.getElementById('sr-preview');
    const enhanceBtn = document.getElementById('sr-enhance-btn');
    const resetBtn = document.getElementById('sr-reset-btn');
    const downloadBtn = document.getElementById('sr-download-btn');
    const newImageBtn = document.getElementById('sr-new-image-btn');
    const progressBar = document.getElementById('sr-progress-bar');
    
    const scaleFactorSelect = document.getElementById('sr-scale-factor');
    const algorithmSelect = document.getElementById('sr-algorithm');
    const sharpeningSlider = document.getElementById('sr-sharpening');
    const noiseReductionSlider = document.getElementById('sr-noise-reduction');
    const sharpeningValue = document.getElementById('sr-sharpening-value');
    const noiseValue = document.getElementById('sr-noise-value');
    
    // Clear/Reset function
    function clearAll() {
        originalImage = null;
        originalFile = null;
        enhancedCanvas = null;
        uploadArea.style.display = 'block';
        previewUpload.style.display = 'none';
        controls.style.display = 'none';
        processing.style.display = 'none';
        preview.style.display = 'none';
        fileInput.value = '';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        sharpeningSlider.value = '30';
        noiseReductionSlider.value = '20';
        sharpeningValue.textContent = '30%';
        noiseValue.textContent = '20%';
    }
    
    // Update slider values
    sharpeningSlider.addEventListener('input', () => {
        sharpeningValue.textContent = sharpeningSlider.value + '%';
    });
    
    noiseReductionSlider.addEventListener('input', () => {
        noiseValue.textContent = noiseReductionSlider.value + '%';
    });
    
    // Choose file button click
    chooseFileBtn.addEventListener('click', (e) => {
        e.preventDefault();
        fileInput.click();
    });
    
    // Upload area click
    uploadArea.addEventListener('click', (e) => {
        if (e.target === uploadArea || e.target.tagName === 'H3' || e.target.tagName === 'P') {
            fileInput.click();
        }
    });
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) handleFile(files[0]);
    });
    
    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
            fileInput.value = '';
        }
    });
    
    // Handle file upload
    function handleFile(file) {
        if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file.');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be less than 10MB.');
            return;
        }
        
        originalFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
            originalImage = new Image();
            originalImage.onload = function() {
                // Show preview of uploaded image
                uploadedPreview.src = e.target.result;
                uploadArea.style.display = 'none';
                previewUpload.style.display = 'block';
                controls.style.display = 'block';
                processing.style.display = 'none';
                preview.style.display = 'none';
                // Don't call updateOriginalStats here as sr-original-img is in preview section
            };
            originalImage.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    
    function updateOriginalStats() {
        // Only update if the original image element exists and is visible
        const originalImgElement = document.getElementById('sr-original-img');
        if (originalImgElement && originalImage) {
            originalImgElement.src = originalImage.src;
            document.getElementById('sr-original-resolution').textContent = `${originalImage.width} √ó ${originalImage.height}`;
            document.getElementById('sr-original-size').textContent = formatFileSize(originalFile.size);
        }
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Change image button
    changeImageBtn.addEventListener('click', clearAll);
    
    // Reset button
    resetBtn.addEventListener('click', clearAll);
    
    // New image button
    newImageBtn.addEventListener('click', clearAll);
    
    // Enhance button functionality
    enhanceBtn.addEventListener('click', () => {
        if (!originalImage) return;
        
        processing.style.display = 'block';
        controls.style.display = 'none';
        preview.style.display = 'none';
        
        // Simulate processing with progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15 + 5;
            if (progress > 95) progress = 95;
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
        }, 200);
        
        // Perform enhancement
        setTimeout(() => {
            enhanceImage().then(() => {
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                
                setTimeout(() => {
                    processing.style.display = 'none';
                    preview.style.display = 'block';
                }, 500);
            });
        }, 1000);
    });
    
    async function enhanceImage() {
        const scaleFactor = parseInt(scaleFactorSelect.value);
        const algorithm = algorithmSelect.value;
        const sharpening = parseInt(sharpeningSlider.value);
        const noiseReduction = parseInt(noiseReductionSlider.value);
        
        // Create canvas for enhancement
        enhancedCanvas = document.createElement('canvas');
        const ctx = enhancedCanvas.getContext('2d');
        
        const newWidth = originalImage.width * scaleFactor;
        const newHeight = originalImage.height * scaleFactor;
        
        enhancedCanvas.width = newWidth;
        enhancedCanvas.height = newHeight;
        
        // Apply enhancement algorithm
        if (algorithm === 'lanczos' || algorithm === 'bicubic') {
            // High quality scaling
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
        } else if (algorithm === 'bilinear') {
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'medium';
        } else {
            ctx.imageSmoothingEnabled = false;
        }
        
        // Draw scaled image
        ctx.drawImage(originalImage, 0, 0, newWidth, newHeight);
        
        // Apply post-processing effects
        if (sharpening > 0 || noiseReduction > 0 || algorithm === 'edge-preserve' || algorithm === 'ai-enhance') {
            const imageData = ctx.getImageData(0, 0, newWidth, newHeight);
            const enhanced = applyEnhancements(imageData, {
                sharpening: sharpening / 100,
                noiseReduction: noiseReduction / 100,
                algorithm: algorithm
            });
            ctx.putImageData(enhanced, 0, 0);
        }
        
        // Update preview
        const enhancedImg = document.getElementById('sr-enhanced-img');
        enhancedImg.src = enhancedCanvas.toDataURL('image/png');
        
        // Update stats
        document.getElementById('sr-enhanced-resolution').textContent = `${newWidth} √ó ${newHeight}`;
        document.getElementById('sr-enhancement-info').textContent = `${scaleFactor}x ${algorithm}`;
        
        // Estimate file size (rough approximation)
        const estimatedSize = (newWidth * newHeight * 3) * 0.7; // Rough compression estimate
        document.getElementById('sr-enhanced-size').textContent = formatFileSize(estimatedSize);
    }
    
    enhanceBtn.addEventListener('click', () => {
        if (!originalImage) return;
        
        processing.style.display = 'block';
        controls.style.display = 'none';
        preview.style.display = 'none';
        
        // Simulate processing with progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15 + 5;
            if (progress > 95) progress = 95;
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
        }, 200);
        
        // Perform enhancement
        setTimeout(() => {
            enhanceImage().then(() => {
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                
                setTimeout(() => {
                    processing.style.display = 'none';
                    preview.style.display = 'block';
                }, 500);
            });
        }, 1000);
    });
    
    async function enhanceImage() {
        const scaleFactor = parseInt(scaleFactorSelect.value);
        const algorithm = algorithmSelect.value;
        const sharpening = parseInt(sharpeningSlider.value);
        const noiseReduction = parseInt(noiseReductionSlider.value);
        
        // Create canvas for enhancement
        enhancedCanvas = document.createElement('canvas');
        const ctx = enhancedCanvas.getContext('2d');
        
        const newWidth = originalImage.width * scaleFactor;
        const newHeight = originalImage.height * scaleFactor;
        
        enhancedCanvas.width = newWidth;
        enhancedCanvas.height = newHeight;
        
        // Apply enhancement algorithm
        if (algorithm === 'lanczos' || algorithm === 'bicubic') {
            // High quality scaling
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
        } else if (algorithm === 'bilinear') {
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'medium';
        } else {
            ctx.imageSmoothingEnabled = false;
        }
        
        // Draw scaled image
        ctx.drawImage(originalImage, 0, 0, newWidth, newHeight);
        
        // Apply post-processing effects
        if (sharpening > 0 || noiseReduction > 0 || algorithm === 'edge-preserve' || algorithm === 'ai-enhance') {
            const imageData = ctx.getImageData(0, 0, newWidth, newHeight);
            const enhanced = applyEnhancements(imageData, {
                sharpening: sharpening / 100,
                noiseReduction: noiseReduction / 100,
                algorithm: algorithm
            });
            ctx.putImageData(enhanced, 0, 0);
        }
        
        // Update preview
        const enhancedImg = document.getElementById('sr-enhanced-img');
        enhancedImg.src = enhancedCanvas.toDataURL('image/png');
        
        // Update stats
        document.getElementById('sr-enhanced-resolution').textContent = `${newWidth} √ó ${newHeight}`;
        document.getElementById('sr-enhancement-info').textContent = `${scaleFactor}x ${algorithm}`;
        
        // Estimate file size (rough approximation)
        const estimatedSize = (newWidth * newHeight * 3) * 0.7; // Rough compression estimate
        document.getElementById('sr-enhanced-size').textContent = formatFileSize(estimatedSize);
    }
    
    function applyEnhancements(imageData, options) {
        const data = imageData.data;
        const width = imageData.width;
        const height = imageData.height;
        const enhanced = new Uint8ClampedArray(data);
        
        // Apply sharpening
        if (options.sharpening > 0) {
            applySharpening(enhanced, width, height, options.sharpening);
        }
        
        // Apply noise reduction
        if (options.noiseReduction > 0) {
            applyNoiseReduction(enhanced, width, height, options.noiseReduction);
        }
        
        // Apply algorithm-specific enhancements
        if (options.algorithm === 'edge-preserve') {
            applyEdgePreservation(enhanced, width, height);
        } else if (options.algorithm === 'ai-enhance') {
            applyAIEnhancement(enhanced, width, height);
        }
        
        return new ImageData(enhanced, width, height);
    }
    
    function applySharpening(data, width, height, strength) {
        const kernel = [
            [0, -1, 0],
            [-1, 5, -1],
            [0, -1, 0]
        ];
        
        applyConvolution(data, width, height, kernel, strength);
    }
    
    function applyNoiseReduction(data, width, height, strength) {
        // Simple bilateral filter approximation
        const tempData = new Uint8ClampedArray(data);
        
        for (let y = 1; y < height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
                const idx = (y * width + x) * 4;
                
                let sumR = 0, sumG = 0, sumB = 0;
                let weight = 0;
                
                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        const nIdx = ((y + dy) * width + (x + dx)) * 4;
                        const w = Math.exp(-((dx * dx + dy * dy) / 2));
                        
                        sumR += tempData[nIdx] * w;
                        sumG += tempData[nIdx + 1] * w;
                        sumB += tempData[nIdx + 2] * w;
                        weight += w;
                    }
                }
                
                data[idx] = data[idx] * (1 - strength) + (sumR / weight) * strength;
                data[idx + 1] = data[idx + 1] * (1 - strength) + (sumG / weight) * strength;
                data[idx + 2] = data[idx + 2] * (1 - strength) + (sumB / weight) * strength;
            }
        }
    }
    
    function applyEdgePreservation(data, width, height) {
        // Simple edge-preserving smoothing
        const tempData = new Uint8ClampedArray(data);
        
        for (let y = 1; y < height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
                const idx = (y * width + x) * 4;
                
                // Calculate local variance
                let variance = 0;
                let mean = 0;
                let count = 0;
                
                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        const nIdx = ((y + dy) * width + (x + dx)) * 4;
                        const gray = (tempData[nIdx] + tempData[nIdx + 1] + tempData[nIdx + 2]) / 3;
                        mean += gray;
                        count++;
                    }
                }
                mean /= count;
                
                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        const nIdx = ((y + dy) * width + (x + dx)) * 4;
                        const gray = (tempData[nIdx] + tempData[nIdx + 1] + tempData[nIdx + 2]) / 3;
                        variance += (gray - mean) * (gray - mean);
                    }
                }
                variance /= count;
                
                // If variance is low (smooth area), apply smoothing
                if (variance < 100) {
                    let sumR = 0, sumG = 0, sumB = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            const nIdx = ((y + dy) * width + (x + dx)) * 4;
                            sumR += tempData[nIdx];
                            sumG += tempData[nIdx + 1];
                            sumB += tempData[nIdx + 2];
                        }
                    }
                    
                    data[idx] = sumR / 9;
                    data[idx + 1] = sumG / 9;
                    data[idx + 2] = sumB / 9;
                }
            }
        }
    }
    
    function applyAIEnhancement(data, width, height) {
        // Simulated AI enhancement using multiple filters
        applySharpening(data, width, height, 0.3);
        applyNoiseReduction(data, width, height, 0.2);
        applyEdgePreservation(data, width, height);
        
        // Enhance contrast slightly
        for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.min(255, data[i] * 1.1);     // R
            data[i + 1] = Math.min(255, data[i + 1] * 1.1); // G
            data[i + 2] = Math.min(255, data[i + 2] * 1.1); // B
        }
    }
    
    function applyConvolution(data, width, height, kernel, strength) {
        const tempData = new Uint8ClampedArray(data);
        const kSize = kernel.length;
        const kCenter = Math.floor(kSize / 2);
        
        for (let y = kCenter; y < height - kCenter; y++) {
            for (let x = kCenter; x < width - kCenter; x++) {
                const idx = (y * width + x) * 4;
                
                let sumR = 0, sumG = 0, sumB = 0;
                
                for (let ky = 0; ky < kSize; ky++) {
                    for (let kx = 0; kx < kSize; kx++) {
                        const nIdx = ((y + ky - kCenter) * width + (x + kx - kCenter)) * 4;
                        const kernelVal = kernel[ky][kx];
                        
                        sumR += tempData[nIdx] * kernelVal;
                        sumG += tempData[nIdx + 1] * kernelVal;
                        sumB += tempData[nIdx + 2] * kernelVal;
                    }
                }
                
                data[idx] = data[idx] * (1 - strength) + Math.max(0, Math.min(255, sumR)) * strength;
                data[idx + 1] = data[idx + 1] * (1 - strength) + Math.max(0, Math.min(255, sumG)) * strength;
                data[idx + 2] = data[idx + 2] * (1 - strength) + Math.max(0, Math.min(255, sumB)) * strength;
            }
        }
    }
    
    downloadBtn.addEventListener('click', () => {
        if (!enhancedCanvas) return;
        
        const link = document.createElement('a');
        link.download = 'super-resolution-enhanced.png';
        link.href = enhancedCanvas.toDataURL('image/png');
        link.click();
    });
    
    resetBtn.addEventListener('click', () => {
        controls.style.display = 'none';
        preview.style.display = 'none';
        processing.style.display = 'none';
        fileInput.value = '';
        originalImage = null;
        enhancedCanvas = null;
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
    });
    
    newImageBtn.addEventListener('click', () => {
        resetBtn.click();
    });
}

// SPA/Router support - matches add-name-dob-photo.html pattern
if (window.initializeSuperResolution === undefined) {
    window.initializeSuperResolution = initializeSuperResolution;
}
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSuperResolution);
} else {
    initializeSuperResolution();
}
</script>
